<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼šå‘˜ä¸­å¿ƒ - è§†é¢‘ç« èŠ‚ç”Ÿæˆå™¨</title>
  <link rel="stylesheet" href="/public/styles.css">
  <script src="/public/payment-ijpay.js"></script>
  <style>
    .profile-container { max-width: 900px; margin: 20px auto; padding: 20px; }
    .profile-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; }
    .balance-display { font-size: 48px; font-weight: bold; margin: 10px 0; }
    .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .card h3 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    .plan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
    .plan-card { border: 2px solid #ddd; padding: 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
    .plan-card:hover { border-color: #007bff; transform: translateY(-2px); }
    .plan-card.selected { border-color: #007bff; background: #f0f8ff; }
    .plan-price { font-size: 32px; font-weight: bold; color: #007bff; margin: 10px 0; }
    .payment-methods { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .payment-btn { padding: 12px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; transition: all 0.3s; text-align: center; }
    .payment-btn:hover { border-color: #28a745; }
    .payment-btn.selected { border-color: #28a745; background: #f0fff0; }
    .btn-primary { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.3s; }
    .btn-primary:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .success-icon { color: #28a745; margin-right: 5px; }
    .info-icon { color: #17a2b8; margin-right: 5px; }
    .info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .nav-buttons { text-align: right; margin-bottom: 15px; }
    .nav-buttons button { margin-left: 10px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="profile-container">
    <div class="nav-buttons">
      <button onclick="window.location.href='/'">ğŸ¬ è¿”å›ä¸»é¡µ</button>
      <button onclick="logout()">ğŸšª é€€å‡ºç™»å½•</button>
    </div>

    <div class="profile-header">
      <h2>ğŸ‘¤ ä¼šå‘˜ä¸­å¿ƒ</h2>
      <div id="userInfo">
        <div style="font-size: 24px; margin-bottom: 10px; font-weight: 600;">æ¬¢è¿å›æ¥ï¼Œ<span id="username">åŠ è½½ä¸­...</span> ğŸ‘‹</div>
        <div style="font-size: 14px; opacity: 0.9; display: flex; align-items: center; gap: 10px;">
          <span>ğŸ“§</span>
          <span id="email">åŠ è½½ä¸­...</span>
        </div>
      </div>
      <div style="margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 12px; backdrop-filter: blur(10px);">
        <div style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;">ğŸ’° è´¦æˆ·ä½™é¢</div>
        <div class="balance-display">
          Â¥ <span id="balance">0.00</span>
        </div>
        <div style="font-size: 13px; opacity: 0.8; margin-top: 8px;">
          <span id="balanceStatus">ä½™é¢å……è¶³ âœ“</span>
        </div>
      </div>
    </div>

    <!-- å……å€¼å¥—é¤ -->
    <div class="card">
      <h3>ğŸ’° å……å€¼å¥—é¤</h3>
      <div class="plan-grid" id="plansContainer">
        åŠ è½½ä¸­...
      </div>

      <h4 style="margin-top: 25px; margin-bottom: 10px;">é€‰æ‹©æ”¯ä»˜æ–¹å¼ (IJPay)</h4>
      <div class="payment-methods" style="grid-template-columns: repeat(2, 1fr);">
        <div class="payment-btn" onclick="selectPayment('wechat')">
          <div style="font-size: 32px;">ğŸ’š</div>
          <div style="font-size: 16px; font-weight: 600;">å¾®ä¿¡æ”¯ä»˜</div>
          <div style="font-size: 11px; color: #999;">æ‰«ç æ”¯ä»˜</div>
        </div>
        <div class="payment-btn" onclick="selectPayment('alipay')">
          <div style="font-size: 32px;">ğŸ’™</div>
          <div style="font-size: 16px; font-weight: 600;">æ”¯ä»˜å®</div>
          <div style="font-size: 11px; color: #999;">æ‰«ç æ”¯ä»˜</div>
        </div>
      </div>

      <button class="btn-primary" onclick="createPaymentOrder()" style="width: 100%; margin-top: 20px; font-size: 18px;">
        ğŸ’° ç«‹å³å……å€¼
      </button>
      <div id="paymentModeIndicator" style="margin-top: 10px; color: #666; font-size: 12px; text-align: center;">
        <!-- Payment mode indicator will be shown here -->
      </div>
    </div>

    <!-- Payment QR Code Modal -->
    <div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 10px 50px rgba(0,0,0,0.5); text-align: center;">
        <h2 style="margin-top: 0; color: #333;" id="paymentTitle">æ‰«ç æ”¯ä»˜</h2>
        
        <div id="qrCodeContainer" style="margin: 30px 0; display: flex; justify-content: center; align-items: center; min-height: 280px;">
          <div class="loading-spinner" style="width: 40px; height: 40px;"></div>
        </div>
        
        <div id="paymentInfo" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="paymentAmount">Â¥0.00</div>
          <div style="font-size: 14px; color: #666; margin-top: 5px;" id="paymentDesc">å……å€¼å¥—é¤</div>
        </div>
        
        <div style="font-size: 13px; color: #999; margin-bottom: 20px;">
          <div>è®¢å•å·ï¼š<span id="orderIdDisplay">-</span></div>
          <div style="margin-top: 5px;">è¯·ä½¿ç”¨ <span id="paymentMethodDisplay" style="font-weight: 600;">å¾®ä¿¡</span> æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜</div>
        </div>
        
        <div style="display: flex; gap: 10px;">
          <button onclick="closePaymentModal()" class="btn-secondary" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
            âŒ å–æ¶ˆæ”¯ä»˜
          </button>
          <button onclick="checkPaymentStatus()" class="btn-primary" style="flex: 1; padding: 12px; font-size: 16px;">
            ğŸ”„ åˆ·æ–°çŠ¶æ€
          </button>
        </div>
      </div>
    </div>

    <!-- ä¼šå‘˜ç­‰çº§ -->
    <div class="card">
      <h3>ğŸ† ä¼šå‘˜ç­‰çº§</h3>
      <div id="membershipLevelContainer">åŠ è½½ä¸­...</div>
    </div>

    <!-- æˆ‘çš„ä¼˜æƒ åˆ¸ -->
    <div class="card">
      <h3>ğŸ« æˆ‘çš„ä¼˜æƒ åˆ¸</h3>
      <div style="margin-bottom: 15px;">
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="text" id="couponCode" placeholder="è¾“å…¥ä¼˜æƒ åˆ¸ç " style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
          <button class="btn-primary" onclick="claimCoupon()" style="white-space: nowrap;">ğŸ é¢†å–ä¼˜æƒ åˆ¸</button>
        </div>
      </div>
      <div id="couponsContainer"></div>
    </div>

    <!-- æ¨èå¥–åŠ± -->
    <div class="card">
      <h3>ğŸ’ æ¨èå¥–åŠ±</h3>
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; margin-bottom: 20px;">
        <div style="font-size: 16px; margin-bottom: 10px;">ğŸ“¢ æˆ‘çš„æ¨èç </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div id="referralCode" style="flex: 1; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; font-size: 24px; font-weight: bold; letter-spacing: 2px; text-align: center;">
            --------
          </div>
          <button onclick="copyReferralCode()" style="background: white; color: #667eea; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
            ğŸ“‹ å¤åˆ¶
          </button>
        </div>
        <div style="margin-top: 10px; font-size: 14px; opacity: 0.9;">
          åˆ†äº«æ‚¨çš„æ¨èç ï¼Œå¥½å‹æ³¨å†Œåæ‚¨å°†è·å¾—å¥–åŠ±ï¼
        </div>
      </div>
      <div id="referralStatsContainer"></div>
      <div id="referralListContainer" style="margin-top: 20px;"></div>
    </div>

    <!-- é€šçŸ¥è®¾ç½® -->
    <div class="card">
      <h3>ğŸ“¢ é€šçŸ¥è®¾ç½®</h3>
      <p style="color: #666; font-size: 14px; margin-bottom: 20px;">é…ç½®æ‚¨çš„é€šçŸ¥æ¥æ”¶æ–¹å¼ï¼Œé™¤é»˜è®¤é‚®ä»¶é€šçŸ¥å¤–ï¼Œè¿˜å¯ä»¥é€‰æ‹©å…¶ä»–æ¸ é“</p>
      
      <div style="margin-bottom: 25px; padding: 15px; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 6px;">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" id="notificationEnabled" checked style="width: 18px; height: 18px;">
          <span style="font-weight: 600; font-size: 15px;">âœ… å¯ç”¨é€šçŸ¥æ¥æ”¶</span>
        </label>
        <div style="font-size: 12px; color: #666; margin-top: 8px; margin-left: 28px;">
          å…³é—­åå°†ä¸ä¼šæ”¶åˆ°ä»»ä½•é€šçŸ¥ï¼ˆåŒ…æ‹¬é‚®ä»¶ï¼‰
        </div>
      </div>
      
      <div id="notificationChannels">
        <!-- WxPusher -->
        <div class="notification-channel" data-channel="wxpusher" style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid transparent; transition: all 0.3s;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 24px;">ğŸ’š</span>
              <h4 style="margin: 0;">WxPusher å¾®ä¿¡æ¨é€</h4>
            </div>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <span id="wxpusher_status" style="font-size: 13px; font-weight: 600; color: #28a745;">âœ… å·²å¯ç”¨</span>
              <input type="checkbox" id="wxpusher_enabled" checked 
                     onchange="toggleChannelStatus('wxpusher', this.checked)"
                     style="width: 18px; height: 18px; cursor: pointer;">
            </label>
          </div>
          <input type="text" id="wxpusher_token" placeholder="è¾“å…¥æ‚¨çš„ WxPusher Token (ä¾‹å¦‚: AT_xxx)" 
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px;">
          <input type="text" id="wxpusher_uid" placeholder="è¾“å…¥æ‚¨çš„ WxPusher UID (ä¾‹å¦‚: UID_xxx)" 
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px;">
          <div style="font-size: 12px; color: #666;">
            <a href="https://wxpusher.zjiecode.com/" target="_blank" style="color: #007bff;">ğŸ“– å¦‚ä½•è·å–Tokenå’ŒUIDï¼Ÿ</a>
            <span style="margin-left: 10px;">æ‰«ç å…³æ³¨å…¬ä¼—å·å³å¯è·å¾—</span>
          </div>
        </div>
        
        <!-- PushPlus -->
        <div class="notification-channel" data-channel="pushplus" style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid transparent; transition: all 0.3s;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 24px;">ğŸ“±</span>
              <h4 style="margin: 0;">PushPlus å¤šå¹³å°æ¨é€</h4>
            </div>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <span id="pushplus_status" style="font-size: 13px; font-weight: 600; color: #28a745;">âœ… å·²å¯ç”¨</span>
              <input type="checkbox" id="pushplus_enabled" checked 
                     onchange="toggleChannelStatus('pushplus', this.checked)"
                     style="width: 18px; height: 18px; cursor: pointer;">
            </label>
          </div>
          <input type="text" id="pushplus_token" placeholder="è¾“å…¥æ‚¨çš„ PushPlus Token" 
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px;">
          <div style="font-size: 12px; color: #666;">
            <a href="http://www.pushplus.plus/" target="_blank" style="color: #007bff;">ğŸ“– å¦‚ä½•è·å–Tokenï¼Ÿ</a>
            <span style="margin-left: 10px;">æ”¯æŒå¾®ä¿¡ã€ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ç­‰</span>
          </div>
        </div>
        
        <!-- Resend Email -->
        <div class="notification-channel" data-channel="resend" style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid transparent; transition: all 0.3s;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 24px;">ğŸ“§</span>
              <h4 style="margin: 0;">Resend é‚®ä»¶é€šçŸ¥</h4>
            </div>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <span id="resend_status" style="font-size: 13px; font-weight: 600; color: #28a745;">âœ… å·²å¯ç”¨</span>
              <input type="checkbox" id="resend_enabled" checked 
                     onchange="toggleChannelStatus('resend', this.checked)"
                     style="width: 18px; height: 18px; cursor: pointer;">
            </label>
          </div>
          <input type="email" id="resend_email" placeholder="è¾“å…¥æ¥æ”¶é€šçŸ¥çš„é‚®ç®±åœ°å€" 
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px;">
          <div style="font-size: 12px; color: #666;">
            <span>é™¤é»˜è®¤QQé‚®ç®±å¤–çš„é¢å¤–é‚®ä»¶é€šçŸ¥</span>
          </div>
        </div>
        
        <!-- Telegram -->
        <div class="notification-channel" data-channel="telegram" style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid transparent; transition: all 0.3s;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 24px;">âœˆï¸</span>
              <h4 style="margin: 0;">Telegram ç”µæŠ¥é€šçŸ¥</h4>
            </div>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <span id="telegram_status" style="font-size: 13px; font-weight: 600; color: #28a745;">âœ… å·²å¯ç”¨</span>
              <input type="checkbox" id="telegram_enabled" checked 
                     onchange="toggleChannelStatus('telegram', this.checked)"
                     style="width: 18px; height: 18px; cursor: pointer;">
            </label>
          </div>
          <input type="text" id="telegram_bot_token" placeholder="è¾“å…¥æ‚¨çš„ Telegram Bot Token (ä¾‹å¦‚: 123456:ABC...)" 
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px;">
          <input type="text" id="telegram_chat_id" placeholder="è¾“å…¥æ‚¨çš„ Telegram Chat ID" 
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px;">
          <div style="font-size: 12px; color: #666;">
            <a href="https://core.telegram.org/bots" target="_blank" style="color: #007bff;">ğŸ“– å¦‚ä½•è·å–Bot Tokenå’ŒChat IDï¼Ÿ</a>
            <span style="margin-left: 10px;">è”ç³» @BotFather åˆ›å»ºBotï¼Œ@userinfobot è·å–ID</span>
          </div>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn-primary" onclick="saveNotificationConfig()" style="flex: 1; font-size: 16px;">
          ğŸ’¾ ä¿å­˜é€šçŸ¥è®¾ç½®
        </button>
        <button class="btn-secondary" onclick="testNotification()" style="flex: 1; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">
          ğŸ§ª æµ‹è¯•é€šçŸ¥
        </button>
      </div>
      
      <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
        <div style="font-size: 13px; color: #856404;">
          <strong>ğŸ’¡ æç¤ºï¼š</strong>
          <ul style="margin: 8px 0 0 20px; padding: 0;">
            <li>æ‰€æœ‰é…ç½®ä¸ºå¯é€‰ï¼Œè‡³å°‘é…ç½®ä¸€ä¸ªæ¸ é“å³å¯æ¥æ”¶é€šçŸ¥</li>
            <li>é»˜è®¤å§‹ç»ˆä¼šå‘é€é‚®ä»¶åˆ°æ³¨å†Œé‚®ç®±ï¼ˆè§†é¢‘å¤„ç†æˆåŠŸæ—¶ï¼‰</li>
            <li>ç®¡ç†å‘˜å¯èƒ½ä¼šé™åˆ¶æŸäº›æ¸ é“çš„ä½¿ç”¨</li>
            <li>ç‚¹å‡»"æµ‹è¯•é€šçŸ¥"å¯ä»¥éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç  -->
    <div class="card">
      <h3>ğŸ” ä¿®æ”¹å¯†ç </h3>
      <div style="max-width: 500px;">
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰å¯†ç </label>
          <input type="password" id="oldPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ–°å¯†ç </label>
          <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼‰" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">ç¡®è®¤æ–°å¯†ç </label>
          <input type="password" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <button class="btn-primary" onclick="changePassword()">ğŸ”’ ä¿®æ”¹å¯†ç </button>
      </div>
    </div>

    <!-- äº¤æ˜“è®°å½• -->
    <div class="card">
      <h3>ğŸ“Š æœ€è¿‘äº¤æ˜“è®°å½•</h3>
      <div id="transactionsContainer">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- Payment QR Code Modal -->
  <div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; text-align: center; box-shadow: 0 10px 50px rgba(0,0,0,0.5);">
      <h2 id="paymentTitle" style="margin: 0 0 20px 0; color: #333;">æ‰«ç æ”¯ä»˜</h2>
      
      <div id="qrCodeContainer" style="margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 12px; display: inline-block;">
        <img id="qrCodeImage" src="" alt="QR Code" style="width: 250px; height: 250px; display: block;">
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #667eea15, #764ba215); border-radius: 10px; border-left: 4px solid #667eea;">
        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">è®¢å•é‡‘é¢</div>
        <div id="paymentAmount" style="font-size: 32px; font-weight: bold; color: #667eea;">Â¥0.00</div>
      </div>
      
      <div style="font-size: 14px; color: #999; margin-bottom: 20px;">
        <div id="paymentInstructions">è¯·ä½¿ç”¨æ‰‹æœºæ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜</div>
        <div id="paymentOrderId" style="margin-top: 10px; font-size: 12px;">è®¢å•å·: -</div>
      </div>
      
      <div id="paymentStatus" style="margin: 15px 0; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 14px; color: #856404;">
        â³ ç­‰å¾…æ”¯ä»˜ä¸­...
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="checkPaymentStatus()" class="btn-primary" style="flex: 1;">
          ğŸ”„ æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
        </button>
        <button onclick="closePaymentModal()" class="btn-primary" style="flex: 1; background: #6c757d;">
          âŒ å–æ¶ˆæ”¯ä»˜
        </button>
      </div>
      
      <div id="mockPaymentSection" style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 2px dashed #ffc107; display: none;">
        <div style="font-size: 13px; color: #856404; margin-bottom: 10px;">
          âš ï¸ æ¼”ç¤ºæ¨¡å¼ï¼šæœªé…ç½®çœŸå®æ”¯ä»˜æ¸ é“
        </div>
        <button onclick="mockConfirmPayment()" class="btn-primary" style="background: #ffc107; color: #333; width: 100%;">
          âœ… æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸï¼ˆæµ‹è¯•ç”¨ï¼‰
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let selectedPlanId = null;
    let selectedPaymentMethod = null;
    let currentUser = null;

    async function loadProfile() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/public/login.html';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const result = await response.json();
        
        if (result.success) {
          currentUser = result.user;
          document.getElementById('username').textContent = currentUser.username;
          document.getElementById('email').textContent = currentUser.email;
          
          // Update balance display with animation
          const balanceElement = document.getElementById('balance');
          const balanceStatus = document.getElementById('balanceStatus');
          if (balanceElement) {
            const balance = currentUser.balance;
            balanceElement.textContent = balance.toFixed(2);
            
            // Update balance status
            if (balance < 5) {
              balanceStatus.textContent = 'ä½™é¢ä¸è¶³ï¼Œè¯·å……å€¼ âš ï¸';
              balanceStatus.style.color = '#ffc107';
            } else if (balance < 20) {
              balanceStatus.textContent = 'ä½™é¢åä½ï¼Œå»ºè®®å……å€¼';
              balanceStatus.style.color = '#f0f0f0';
            } else {
              balanceStatus.textContent = 'ä½™é¢å……è¶³ âœ“';
              balanceStatus.style.color = '#90ee90';
            }
          }
          
          // Load payment plans (always fetch latest prices)
          await loadPaymentPlans();
          
          // Load membership level
          loadMembershipLevel();
          
          // Load coupons
          loadCoupons();
          
          // Load referral code and stats
          loadReferralInfo();
          
          // Load notification config
          loadNotificationConfig();
          
          loadTransactions();
        } else {
          window.location.href = '/public/login.html';
        }
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        window.location.href = '/public/login.html';
      }
    }

    // Load payment plans dynamically
    async function loadPaymentPlans() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/auth/payment-plans?t=${Date.now()}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        if (result.success && result.plans) {
          // Save plans to localStorage for later use
          localStorage.setItem('paymentPlans', JSON.stringify(result.plans));
          renderPaymentPlans(result.plans);
        }
      } catch (error) {
        console.error('åŠ è½½å¥—é¤å¤±è´¥:', error);
      }
    }

    // Render payment plans
    function renderPaymentPlans(plans) {
      const container = document.getElementById('plansContainer');
      
      // Sort plans by price
      plans.sort((a, b) => a.price - b.price);
      
      const html = plans.map(plan => {
        let icon = '';
        let highlight = '';
        
        if (plan.type === 'yearly') {
          icon = 'ğŸ”¥';
          highlight = 'color: #ff6b6b;';
        }
        
        return `
          <div class="plan-card" onclick="selectPlan(${plan.id})">
            <div style="font-size: 18px; font-weight: 600; ${highlight}">${plan.name} ${icon}</div>
            <div class="plan-price">Â¥${parseFloat(plan.price).toFixed(2)}</div>
            <div style="color: #666; font-size: 14px;">${plan.description || ''}</div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
    }

    async function loadTransactions() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/auth/transactions?limit=10`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        if (result.success && result.transactions.length > 0) {
          const html = result.transactions.map(t => `
            <div class="info-item">
              <div>
                <strong>${t.type === 'recharge' ? 'ğŸ’° å……å€¼' : 'ğŸ“ æ¶ˆè´¹'}</strong>
                <span style="margin-left: 10px;">${t.description}</span>
              </div>
              <div>
                <span style="color: ${t.type === 'recharge' ? '#28a745' : '#dc3545'}; font-weight: 600;">
                  ${t.type === 'recharge' ? '+' : ''}Â¥${Math.abs(t.amount).toFixed(2)}
                </span>
                <span style="margin-left: 10px; color: #999; font-size: 12px;">
                  ${new Date(t.created_at).toLocaleString('zh-CN')}
                </span>
              </div>
            </div>
          `).join('');
          document.getElementById('transactionsContainer').innerHTML = html;
        } else {
          document.getElementById('transactionsContainer').innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æš‚æ— äº¤æ˜“è®°å½•</div>';
        }
      } catch (error) {
        console.error('åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥:', error);
      }
    }

    function selectPlan(planId) {
      window.selectedPlanId = planId;
      document.querySelectorAll('.plan-card').forEach((card, index) => {
        card.classList.toggle('selected', index + 1 === planId);
      });
    }

    function selectPayment(method) {
      window.selectedPaymentMethod = method;
      document.querySelectorAll('.payment-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.closest('.payment-btn').classList.add('selected');
    }

    // Global variables for payment
    let currentOrderId = null;
    let paymentStatusCheckInterval = null;
    
    async function recharge() {
      if (!selectedPlanId) {
        alert('âŒ è¯·é€‰æ‹©å……å€¼å¥—é¤');
        return;
      }
      if (!selectedPaymentMethod) {
        alert('âŒ è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼');
        return;
      }

      const token = localStorage.getItem('token');
      const rechargeBtn = event.target;
      rechargeBtn.disabled = true;
      rechargeBtn.innerHTML = '<span class="loading-spinner"></span>åˆ›å»ºè®¢å•ä¸­...';
      
      try {
        // Get plan info
        const plans = JSON.parse(localStorage.getItem('paymentPlans') || '[]');
        const selectedPlan = plans.find(p => p.id === selectedPlanId);
        const amount = selectedPlan ? parseFloat(selectedPlan.price) : 0;
        
        const response = await fetch(`${API_BASE}/api/payment/create-order`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            planId: window.selectedPlanId,
            paymentMethod: window.selectedPaymentMethod
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Store order ID
          window.currentOrderId = result.orderId;
          
          // Show payment modal with QR code (function from payment-ijpay.js)
          if (typeof showPaymentModal === 'function') {
            showPaymentModal(result);
          }
          
          // Reset button
          rechargeBtn.disabled = false;
          rechargeBtn.innerHTML = 'ğŸ’° ç«‹å³å……å€¼';
        } else {
          alert('âŒ åˆ›å»ºè®¢å•å¤±è´¥: ' + result.error);
          rechargeBtn.disabled = false;
          rechargeBtn.innerHTML = 'ğŸ’° ç«‹å³å……å€¼';
        }
      } catch (error) {
        console.error('å……å€¼é”™è¯¯:', error);
        alert('âŒ åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        rechargeBtn.disabled = false;
        rechargeBtn.innerHTML = 'ğŸ’° ç«‹å³å……å€¼';
      }
    }
    
    function showPaymentModal(paymentData, amount) {
      const modal = document.getElementById('paymentModal');
      const qrCodeImage = document.getElementById('qrCodeImage');
      const paymentTitle = document.getElementById('paymentTitle');
      const paymentAmount = document.getElementById('paymentAmount');
      const paymentOrderId = document.getElementById('paymentOrderId');
      const paymentInstructions = document.getElementById('paymentInstructions');
      const mockSection = document.getElementById('mockPaymentSection');
      const modeIndicator = document.getElementById('paymentModeIndicator');
      
      // Set payment title
      if (paymentData.paymentType === 'wechat') {
        paymentTitle.textContent = 'ğŸ’š å¾®ä¿¡æ‰«ç æ”¯ä»˜';
        paymentInstructions.textContent = 'è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ä¸€æ‰«å®Œæˆæ”¯ä»˜';
      } else if (paymentData.paymentType === 'alipay') {
        paymentTitle.textContent = 'ğŸ’™ æ”¯ä»˜å®æ‰«ç æ”¯ä»˜';
        paymentInstructions.textContent = 'è¯·ä½¿ç”¨æ”¯ä»˜å®æ‰«ä¸€æ‰«å®Œæˆæ”¯ä»˜';
      }
      
      // Set QR code
      if (paymentData.qrCode) {
        qrCodeImage.src = paymentData.qrCode;
      }
      
      // Set amount and order ID
      paymentAmount.textContent = `Â¥${amount.toFixed(2)}`;
      paymentOrderId.textContent = `è®¢å•å·: ${paymentData.orderId}`;
      
      // Show mock section if in mock mode
      if (paymentData.mockMode) {
        mockSection.style.display = 'block';
        modeIndicator.innerHTML = '<span style="color: #ffc107;">âš ï¸ æ¼”ç¤ºæ¨¡å¼ - ç‚¹å‡»"æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ"æŒ‰é’®æµ‹è¯•</span>';
      } else {
        mockSection.style.display = 'none';
        modeIndicator.innerHTML = '<span style="color: #28a745;">âœ“ çœŸå®æ”¯ä»˜æ¸ é“å·²æ¥å…¥</span>';
      }
      
      // Show modal
      modal.style.display = 'flex';
      
      // Start checking payment status (every 3 seconds)
      startPaymentStatusCheck();
    }
    
    function closePaymentModal() {
      const modal = document.getElementById('paymentModal');
      modal.style.display = 'none';
      currentOrderId = null;
      stopPaymentStatusCheck();
    }
    
    function startPaymentStatusCheck() {
      stopPaymentStatusCheck();
      paymentCheckInterval = setInterval(checkPaymentStatus, 3000);
    }
    
    function stopPaymentStatusCheck() {
      if (paymentCheckInterval) {
        clearInterval(paymentCheckInterval);
        paymentCheckInterval = null;
      }
    }
    
    async function checkPaymentStatus() {
      if (!currentOrderId) return;
      
      const token = localStorage.getItem('token');
      const statusDiv = document.getElementById('paymentStatus');
      
      try {
        statusDiv.innerHTML = 'ğŸ”„ æ£€æŸ¥æ”¯ä»˜çŠ¶æ€ä¸­...';
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        
        const response = await fetch(`${API_BASE}/api/payment/query-order/${currentOrderId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const result = await response.json();
        
        if (result.success && result.paid) {
          // Payment successful
          stopPaymentStatusCheck();
          statusDiv.innerHTML = 'âœ… æ”¯ä»˜æˆåŠŸï¼';
          statusDiv.style.background = '#d4edda';
          statusDiv.style.color = '#155724';
          
          setTimeout(() => {
            closePaymentModal();
            alert('ğŸ‰ å……å€¼æˆåŠŸï¼æ­£åœ¨åˆ·æ–°é¡µé¢...');
            loadProfile();
          }, 1500);
        } else {
          statusDiv.innerHTML = 'â³ ç­‰å¾…æ”¯ä»˜ä¸­...';
          statusDiv.style.background = '#fff3cd';
          statusDiv.style.color = '#856404';
        }
      } catch (error) {
        console.error('æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€é”™è¯¯:', error);
        statusDiv.innerHTML = 'âŒ æŸ¥è¯¢å¤±è´¥ï¼Œè¯·é‡è¯•';
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
      }
    }
    
    async function mockConfirmPayment() {
      if (!currentOrderId) return;
      
      const token = localStorage.getItem('token');
      const statusDiv = document.getElementById('paymentStatus');
      
      try {
        statusDiv.innerHTML = 'â³ å¤„ç†ä¸­...';
        
        const response = await fetch(`${API_BASE}/api/payment/mock-confirm/${currentOrderId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const result = await response.json();
        
        if (result.success) {
          stopPaymentStatusCheck();
          statusDiv.innerHTML = 'âœ… æ”¯ä»˜æˆåŠŸï¼';
          statusDiv.style.background = '#d4edda';
          statusDiv.style.color = '#155724';
          
          setTimeout(() => {
            closePaymentModal();
            alert(`ğŸ‰ å……å€¼æˆåŠŸï¼\n\næ–°ä½™é¢: Â¥${result.newBalance.toFixed(2)}`);
            loadProfile();
          }, 1000);
        } else {
          alert('âŒ æ“ä½œå¤±è´¥: ' + result.error);
        }
      } catch (error) {
        console.error('æ¨¡æ‹Ÿæ”¯ä»˜é”™è¯¯:', error);
        alert('âŒ æ“ä½œå¤±è´¥');
      }
    }

    async function changePassword() {
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (!oldPassword || !newPassword || !confirmPassword) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ');
        return;
      }

      if (newPassword.length < 8) {
        alert('æ–°å¯†ç è‡³å°‘éœ€è¦8ä½');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/auth/change-password`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ oldPassword, newPassword })
        });

        const result = await response.json();

        if (result.success) {
          alert('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼è¯·é‡æ–°ç™»å½•');
          logout();
        } else {
          alert('âŒ ' + result.error);
        }
      } catch (error) {
        console.error('ä¿®æ”¹å¯†ç é”™è¯¯:', error);
        alert('ä¿®æ”¹å¯†ç å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/public/login.html';
    }

    // ==================== Membership Level ====================
    
    async function loadMembershipLevel() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/membership/my-level`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        if (result.success) {
          renderMembershipLevel(result.membership);
        }
      } catch (error) {
        console.error('åŠ è½½ä¼šå‘˜ç­‰çº§å¤±è´¥:', error);
      }
    }
    
    function renderMembershipLevel(membership) {
      if (!membership || !membership.name) {
        document.getElementById('membershipLevelContainer').innerHTML = '<div style="color: #999; padding: 20px; text-align: center;">æš‚æ— ç­‰çº§ä¿¡æ¯</div>';
        return;
      }
      
      // æ ¹æ®ç­‰çº§åç§°è®¾ç½®é¢œè‰²
      const levelColors = {
        'æ™®é€šä¼šå‘˜': '#95a5a6',
        'é“¶ç‰Œä¼šå‘˜': '#c0c0c0',
        'é‡‘ç‰Œä¼šå‘˜': '#ffd700',
        'é’»çŸ³ä¼šå‘˜': '#b9f2ff'
      };
      const color = levelColors[membership.name] || '#667eea';
      
      const html = `
        <div style="background: linear-gradient(135deg, ${color}20 0%, ${color}40 100%); padding: 25px; border-radius: 12px; border-left: 5px solid ${color};">
          <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
            <div style="font-size: 48px;">${membership.icon || 'ğŸŒ±'}</div>
            <div>
              <div style="font-size: 24px; font-weight: bold; color: ${color};">
                ${membership.name}
              </div>
              <div style="font-size: 14px; color: #666; margin-top: 5px;">
                ç´¯è®¡å……å€¼: Â¥${parseFloat(membership.total_recharged || 0).toFixed(2)}
              </div>
            </div>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <div style="margin-bottom: 15px;">
              <div style="font-size: 14px; color: #666; margin-bottom: 8px;"><strong>ç­‰çº§æƒç›Šï¼š</strong></div>
              <div style="color: #333;">${membership.benefits || 'åŸºç¡€åŠŸèƒ½'}</div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
              <div style="text-align: center;">
                <div style="font-size: 12px; color: #999;">ç´¯è®¡å……å€¼</div>
                <div style="font-size: 20px; font-weight: bold; color: #667eea;">Â¥${parseFloat(membership.total_recharged || 0).toFixed(2)}</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 12px; color: #999;">ä¼šå‘˜æŠ˜æ‰£</div>
                <div style="font-size: 20px; font-weight: bold; color: #28a745;">${membership.discount || 0}% OFF</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 12px; color: #999;">æœ€ä½å……å€¼</div>
                <div style="font-size: 20px; font-weight: bold; color: #ffc107;">Â¥${parseFloat(membership.min_recharge || 0).toFixed(0)}</div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('membershipLevelContainer').innerHTML = html;
    }
    
    // ==================== Coupons ====================
    
    async function loadCoupons() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/membership/my-coupons`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        if (result.success) {
          renderCoupons(result.coupons);
        }
      } catch (error) {
        console.error('åŠ è½½ä¼˜æƒ åˆ¸å¤±è´¥:', error);
      }
    }
    
    function renderCoupons(coupons) {
      if (!coupons || coupons.length === 0) {
        document.getElementById('couponsContainer').innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— ä¼˜æƒ åˆ¸</div>';
        return;
      }
      
      const html = coupons.map(coupon => {
        const isExpired = new Date(coupon.valid_until) < new Date();
        const isUsed = coupon.is_used;
        const statusBadge = isUsed ? 'å·²ä½¿ç”¨' : isExpired ? 'å·²è¿‡æœŸ' : 'å¯ç”¨';
        const statusColor = isUsed ? '#999' : isExpired ? '#f39c12' : '#28a745';
        
        return `
          <div style="background: ${isUsed || isExpired ? '#f5f5f5' : 'linear-gradient(135deg, #667eea20 0%, #764ba240 100%)'}; border: 2px dashed ${statusColor}; border-radius: 12px; padding: 15px; margin-bottom: 10px; position: relative; ${isUsed || isExpired ? 'opacity: 0.6;' : ''}">
            <div style="position: absolute; top: 10px; right: 10px; background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
              ${statusBadge}
            </div>
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">${coupon.name}</div>
            <div style="font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 5px;">
              ${coupon.type === 'percentage' ? coupon.discount_value + 'æŠ˜' : 'Â¥' + parseFloat(coupon.discount_value).toFixed(2)}
            </div>
            <div style="font-size: 12px; color: #666;">
              æœ€ä½æ¶ˆè´¹: Â¥${parseFloat(coupon.min_purchase).toFixed(2)} | 
              æœ‰æ•ˆæœŸè‡³: ${new Date(coupon.valid_until).toLocaleDateString('zh-CN')}
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">
              ä¼˜æƒ ç : ${coupon.code}
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('couponsContainer').innerHTML = html;
    }
    
    async function claimCoupon() {
      const code = document.getElementById('couponCode').value.trim();
      if (!code) {
        alert('è¯·è¾“å…¥ä¼˜æƒ åˆ¸ç ');
        return;
      }
      
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/membership/claim-coupon`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ code })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ä¼˜æƒ åˆ¸é¢†å–æˆåŠŸï¼');
          document.getElementById('couponCode').value = '';
          loadCoupons();
        } else {
          alert('âŒ ' + (result.error || 'é¢†å–å¤±è´¥'));
        }
      } catch (error) {
        console.error('é¢†å–ä¼˜æƒ åˆ¸å¤±è´¥:', error);
        alert('âŒ é¢†å–å¤±è´¥');
      }
    }
    
    // ==================== Referrals ====================
    
    async function loadReferralInfo() {
      const token = localStorage.getItem('token');
      try {
        // Load referral code
        const codeResponse = await fetch(`${API_BASE}/api/membership/my-referral-code`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const codeResult = await codeResponse.json();
        
        if (codeResult.success) {
          document.getElementById('referralCode').textContent = codeResult.referralCode;
        }
        
        // Load referrals and stats
        const referralsResponse = await fetch(`${API_BASE}/api/membership/my-referrals`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const referralsResult = await referralsResponse.json();
        
        if (referralsResult.success) {
          renderReferralStats(referralsResult.stats);
          renderReferralList(referralsResult.referrals);
        }
      } catch (error) {
        console.error('åŠ è½½æ¨èä¿¡æ¯å¤±è´¥:', error);
      }
    }
    
    function renderReferralStats(stats) {
      const html = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">æ¨èäººæ•°</div>
            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_referrals || 0}</div>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">å·²å¥–åŠ±</div>
            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${stats.rewarded_referrals || 0}</div>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">ç´¯è®¡å¥–åŠ±</div>
            <div style="font-size: 24px; font-weight: bold; color: #ffc107;">Â¥${parseFloat(stats.total_rewards || 0).toFixed(2)}</div>
          </div>
        </div>
      `;
      
      document.getElementById('referralStatsContainer').innerHTML = html;
    }
    
    function renderReferralList(referrals) {
      if (!referrals || referrals.length === 0) {
        document.getElementById('referralListContainer').innerHTML = '<div style="text-align: center; color: #999; padding: 20px; background: #f8f9fa; border-radius: 8px;">è¿˜æ²¡æœ‰æ¨èè®°å½•</div>';
        return;
      }
      
      const html = `
        <h4 style="margin-bottom: 15px;">æ¨èè®°å½•</h4>
        <div style="max-height: 300px; overflow-y: auto;">
          ${referrals.map(ref => `
            <div style="background: white; border: 1px solid #e0e0e0; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">ğŸ‘¤ ${ref.referred_username}</div>
                  <div style="font-size: 12px; color: #666;">æ³¨å†Œæ—¶é—´: ${new Date(ref.referred_created_at).toLocaleDateString('zh-CN')}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-weight: bold; color: ${ref.reward_given ? '#28a745' : '#ffc107'};">
                    ${ref.reward_given ? 'âœ… å·²å¥–åŠ±' : 'â³ å¾…æ¿€æ´»'}
                  </div>
                  <div style="font-size: 12px; color: #666;">Â¥${parseFloat(ref.reward_amount).toFixed(2)}</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      document.getElementById('referralListContainer').innerHTML = html;
    }
    
    function copyReferralCode() {
      const code = document.getElementById('referralCode').textContent;
      if (!code || code === '--------') {
        alert('æ¨èç åŠ è½½ä¸­ï¼Œè¯·ç¨å€™');
        return;
      }
      
      navigator.clipboard.writeText(code).then(() => {
        alert('âœ… æ¨èç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n' + code + '\n\nåˆ†äº«ç»™å¥½å‹å³å¯è·å¾—å¥–åŠ±');
      }).catch(() => {
        alert('å¤åˆ¶å¤±è´¥ï¼Œæ‚¨çš„æ¨èç æ˜¯ï¼š' + code);
      });
    }

    // ==================== Notification Configuration ====================
    
    async function loadNotificationConfig() {
      const token = localStorage.getItem('token');
      
      try {
        // Get user config
        const userConfigResponse = await fetch(`${API_BASE}/api/notifications/user/config`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const config = await userConfigResponse.json();
        
        // Get available channels
        const channelsResponse = await fetch(`${API_BASE}/api/notifications/channels`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const channelSettings = await channelsResponse.json();
        
        // Fill form
        document.getElementById('notificationEnabled').checked = config.notification_enabled !== false;
        document.getElementById('wxpusher_token').value = config.wxpusher_token || '';
        document.getElementById('wxpusher_uid').value = config.wxpusher_uid || '';
        document.getElementById('wxpusher_enabled').checked = config.wxpusher_enabled !== false;
        document.getElementById('pushplus_token').value = config.pushplus_token || '';
        document.getElementById('pushplus_enabled').checked = config.pushplus_enabled !== false;
        document.getElementById('resend_email').value = config.resend_email || '';
        document.getElementById('resend_enabled').checked = config.resend_enabled !== false;
        document.getElementById('telegram_bot_token').value = config.telegram_bot_token || '';
        document.getElementById('telegram_chat_id').value = config.telegram_chat_id || '';
        document.getElementById('telegram_enabled').checked = config.telegram_enabled !== false;
        
        // Update status labels
        toggleChannelStatus('wxpusher', config.wxpusher_enabled !== false);
        toggleChannelStatus('pushplus', config.pushplus_enabled !== false);
        toggleChannelStatus('resend', config.resend_enabled !== false);
        toggleChannelStatus('telegram', config.telegram_enabled !== false);
        
        // Disable channels that admin has turned off
        channelSettings.forEach(ch => {
          const element = document.querySelector(`[data-channel="${ch.channel}"]`);
          if (element && !ch.enabled) {
            element.style.opacity = '0.5';
            element.style.pointerEvents = 'none';
            const input = element.querySelector('input');
            if (input) {
              input.disabled = true;
              input.placeholder += ' (ç®¡ç†å‘˜å·²ç¦ç”¨æ­¤æ¸ é“)';
            }
          }
        });
      } catch (error) {
        console.error('åŠ è½½é€šçŸ¥é…ç½®å¤±è´¥:', error);
      }
    }
    
    async function saveNotificationConfig() {
      const token = localStorage.getItem('token');
      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>ä¿å­˜ä¸­...';
      
      const config = {
        notification_enabled: document.getElementById('notificationEnabled').checked,
        wxpusher_token: document.getElementById('wxpusher_token').value.trim(),
        wxpusher_uid: document.getElementById('wxpusher_uid').value.trim(),
        wxpusher_enabled: document.getElementById('wxpusher_enabled').checked,
        pushplus_token: document.getElementById('pushplus_token').value.trim(),
        pushplus_enabled: document.getElementById('pushplus_enabled').checked,
        resend_email: document.getElementById('resend_email').value.trim(),
        resend_enabled: document.getElementById('resend_enabled').checked,
        telegram_bot_token: document.getElementById('telegram_bot_token').value.trim(),
        telegram_chat_id: document.getElementById('telegram_chat_id').value.trim(),
        telegram_enabled: document.getElementById('telegram_enabled').checked
      };
      
      try {
        const response = await fetch(`${API_BASE}/api/notifications/user/config`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(config)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… é€šçŸ¥è®¾ç½®ä¿å­˜æˆåŠŸï¼');
        } else {
          alert('âŒ ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        console.error('ä¿å­˜é€šçŸ¥é…ç½®å¤±è´¥:', error);
        alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ’¾ ä¿å­˜é€šçŸ¥è®¾ç½®';
      }
    }
    
    async function testNotification() {
      const token = localStorage.getItem('token');
      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>æµ‹è¯•ä¸­...';
      
      try {
        const response = await fetch(`${API_BASE}/api/notifications/test`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ channel: 'all' })
        });
        
        const result = await response.json();
        
        if (result.success) {
          const channels = Object.keys(result.result);
          const successCount = channels.filter(ch => result.result[ch].status === 'success').length;
          alert(`âœ… æµ‹è¯•é€šçŸ¥å·²å‘é€ï¼\n\næˆåŠŸ: ${successCount}/${channels.length} ä¸ªæ¸ é“\n\nè¯·æ£€æŸ¥æ‚¨é…ç½®çš„é€šçŸ¥æ¸ é“æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯`);
        } else {
          alert('âŒ æµ‹è¯•å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
        alert('âŒ æµ‹è¯•å¤±è´¥: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ§ª æµ‹è¯•é€šçŸ¥';
      }
    }

    // Toggle channel visual status and update UI
    function toggleChannelStatus(channel, enabled) {
      const statusElement = document.getElementById(`${channel}_status`);
      const channelCard = document.querySelector(`[data-channel="${channel}"]`);
      const inputs = channelCard.querySelectorAll('input[type="text"], input[type="email"]');
      
      if (statusElement) {
        if (enabled) {
          statusElement.textContent = 'âœ… å·²å¯ç”¨';
          statusElement.style.color = '#28a745';
          channelCard.style.opacity = '1';
          channelCard.style.borderColor = 'transparent';
          inputs.forEach(input => {
            if (input.type !== 'checkbox') {
              input.disabled = false;
              input.style.opacity = '1';
            }
          });
        } else {
          statusElement.textContent = 'âŒ å·²ç¦ç”¨';
          statusElement.style.color = '#dc3545';
          channelCard.style.opacity = '0.6';
          channelCard.style.borderColor = '#dc3545';
          inputs.forEach(input => {
            if (input.type !== 'checkbox') {
              input.disabled = true;
              input.style.opacity = '0.5';
            }
          });
        }
      }
    }

    loadProfile();
  </script>
</body>
</html>
