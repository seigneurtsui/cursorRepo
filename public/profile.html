<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>会员中心 - 视频章节生成器</title>
  <link rel="stylesheet" href="/public/styles.css">
  <style>
    .profile-container { max-width: 900px; margin: 20px auto; padding: 20px; }
    .profile-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; }
    .balance-display { font-size: 48px; font-weight: bold; margin: 10px 0; }
    .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .card h3 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    .plan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
    .plan-card { border: 2px solid #ddd; padding: 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
    .plan-card:hover { border-color: #007bff; transform: translateY(-2px); }
    .plan-card.selected { border-color: #007bff; background: #f0f8ff; }
    .plan-price { font-size: 32px; font-weight: bold; color: #007bff; margin: 10px 0; }
    .payment-methods { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .payment-btn { padding: 12px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; transition: all 0.3s; text-align: center; }
    .payment-btn:hover { border-color: #28a745; }
    .payment-btn.selected { border-color: #28a745; background: #f0fff0; }
    .btn-primary { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.3s; }
    .btn-primary:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .success-icon { color: #28a745; margin-right: 5px; }
    .info-icon { color: #17a2b8; margin-right: 5px; }
    .info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .nav-buttons { text-align: right; margin-bottom: 15px; }
    .nav-buttons button { margin-left: 10px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="profile-container">
    <div class="nav-buttons">
      <button onclick="window.location.href='/'">🎬 返回主页</button>
      <button onclick="logout()">🚪 退出登录</button>
    </div>

    <div class="profile-header">
      <h2>👤 会员中心</h2>
      <div id="userInfo">
        <div style="font-size: 24px; margin-bottom: 10px; font-weight: 600;">欢迎回来，<span id="username">加载中...</span> 👋</div>
        <div style="font-size: 14px; opacity: 0.9; display: flex; align-items: center; gap: 10px;">
          <span>📧</span>
          <span id="email">加载中...</span>
        </div>
      </div>
      <div style="margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 12px; backdrop-filter: blur(10px);">
        <div style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;">💰 账户余额</div>
        <div class="balance-display">
          ¥ <span id="balance">0.00</span>
        </div>
        <div style="font-size: 13px; opacity: 0.8; margin-top: 8px;">
          <span id="balanceStatus">余额充足 ✓</span>
        </div>
      </div>
    </div>

    <!-- 充值套餐 -->
    <div class="card">
      <h3>💰 充值套餐</h3>
      <div class="plan-grid" id="plansContainer">
        加载中...
      </div>

      <h4 style="margin-top: 25px; margin-bottom: 10px;">选择支付方式</h4>
      <div class="payment-methods">
        <div class="payment-btn" onclick="selectPayment('alipay')">
          <div style="font-size: 24px;">💳</div>
          <div style="font-size: 14px;">支付宝</div>
        </div>
        <div class="payment-btn" onclick="selectPayment('wechat')">
          <div style="font-size: 24px;">💚</div>
          <div style="font-size: 14px;">微信支付</div>
        </div>
        <div class="payment-btn" onclick="selectPayment('stripe')">
          <div style="font-size: 24px;">💳</div>
          <div style="font-size: 14px;">Stripe</div>
        </div>
        <div class="payment-btn" onclick="selectPayment('paypal')">
          <div style="font-size: 24px;">💙</div>
          <div style="font-size: 14px;">PayPal</div>
        </div>
        <div class="payment-btn" onclick="selectPayment('visa')">
          <div style="font-size: 24px;">💳</div>
          <div style="font-size: 14px;">Visa</div>
        </div>
        <div class="payment-btn" onclick="selectPayment('mastercard')">
          <div style="font-size: 24px;">💳</div>
          <div style="font-size: 14px;">MasterCard</div>
        </div>
      </div>

      <button class="btn-primary" onclick="recharge()" style="width: 100%; margin-top: 20px; font-size: 18px;">
        💰 立即充值（演示版-自动到账）
      </button>
      <div style="margin-top: 10px; color: #999; font-size: 12px; text-align: center;">
        ⚠️ 当前为演示版本，点击充值将模拟支付并立即到账
      </div>
    </div>

    <!-- 会员等级 -->
    <div class="card">
      <h3>🏆 会员等级</h3>
      <div id="membershipLevelContainer">加载中...</div>
    </div>

    <!-- 我的优惠券 -->
    <div class="card">
      <h3>🎫 我的优惠券</h3>
      <div style="margin-bottom: 15px;">
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="text" id="couponCode" placeholder="输入优惠券码" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
          <button class="btn-primary" onclick="claimCoupon()" style="white-space: nowrap;">🎁 领取优惠券</button>
        </div>
      </div>
      <div id="couponsContainer">加载中...</div>
    </div>

    <!-- 推荐奖励 -->
    <div class="card">
      <h3>💝 推荐奖励</h3>
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; margin-bottom: 20px;">
        <div style="font-size: 16px; margin-bottom: 10px;">📢 我的推荐码</div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div id="referralCode" style="flex: 1; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; font-size: 24px; font-weight: bold; letter-spacing: 2px; text-align: center;">
            --------
          </div>
          <button onclick="copyReferralCode()" style="background: white; color: #667eea; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
            📋 复制
          </button>
        </div>
        <div style="margin-top: 10px; font-size: 14px; opacity: 0.9;">
          分享您的推荐码，好友注册后您将获得奖励！
        </div>
      </div>
      <div id="referralStatsContainer">加载中...</div>
      <div id="referralListContainer" style="margin-top: 20px;"></div>
    </div>

    <!-- 修改密码 -->
    <div class="card">
      <h3>🔐 修改密码</h3>
      <div style="max-width: 500px;">
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">当前密码</label>
          <input type="password" id="oldPassword" placeholder="请输入当前密码" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">新密码</label>
          <input type="password" id="newPassword" placeholder="请输入新密码（至少8位）" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">确认新密码</label>
          <input type="password" id="confirmPassword" placeholder="请再次输入新密码" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <button class="btn-primary" onclick="changePassword()">🔒 修改密码</button>
      </div>
    </div>

    <!-- 交易记录 -->
    <div class="card">
      <h3>📊 最近交易记录</h3>
      <div id="transactionsContainer">加载中...</div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let selectedPlanId = null;
    let selectedPaymentMethod = null;
    let currentUser = null;

    async function loadProfile() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/public/login.html';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const result = await response.json();
        
        if (result.success) {
          currentUser = result.user;
          document.getElementById('username').textContent = currentUser.username;
          document.getElementById('email').textContent = currentUser.email;
          
          // Update balance display with animation
          const balanceElement = document.getElementById('balance');
          const balanceStatus = document.getElementById('balanceStatus');
          if (balanceElement) {
            const balance = currentUser.balance;
            balanceElement.textContent = balance.toFixed(2);
            
            // Update balance status
            if (balance < 5) {
              balanceStatus.textContent = '余额不足，请充值 ⚠️';
              balanceStatus.style.color = '#ffc107';
            } else if (balance < 20) {
              balanceStatus.textContent = '余额偏低，建议充值';
              balanceStatus.style.color = '#f0f0f0';
            } else {
              balanceStatus.textContent = '余额充足 ✓';
              balanceStatus.style.color = '#90ee90';
            }
          }
          
          // Load payment plans (always fetch latest prices)
          await loadPaymentPlans();
          
          // Load membership level
          loadMembershipLevel();
          
          // Load coupons
          loadCoupons();
          
          // Load referral code and stats
          loadReferralInfo();
          
          loadTransactions();
        } else {
          window.location.href = '/public/login.html';
        }
      } catch (error) {
        console.error('加载用户信息失败:', error);
        window.location.href = '/public/login.html';
      }
    }

    // Load payment plans dynamically
    async function loadPaymentPlans() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/auth/payment-plans?t=${Date.now()}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        if (result.success && result.plans) {
          renderPaymentPlans(result.plans);
        }
      } catch (error) {
        console.error('加载套餐失败:', error);
      }
    }

    // Render payment plans
    function renderPaymentPlans(plans) {
      const container = document.getElementById('plansContainer');
      
      // Sort plans by price
      plans.sort((a, b) => a.price - b.price);
      
      const html = plans.map(plan => {
        let icon = '';
        let highlight = '';
        
        if (plan.type === 'yearly') {
          icon = '🔥';
          highlight = 'color: #ff6b6b;';
        }
        
        return `
          <div class="plan-card" onclick="selectPlan(${plan.id})">
            <div style="font-size: 18px; font-weight: 600; ${highlight}">${plan.name} ${icon}</div>
            <div class="plan-price">¥${parseFloat(plan.price).toFixed(2)}</div>
            <div style="color: #666; font-size: 14px;">${plan.description || ''}</div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
    }

    async function loadTransactions() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/auth/transactions?limit=10`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        if (result.success && result.transactions.length > 0) {
          const html = result.transactions.map(t => `
            <div class="info-item">
              <div>
                <strong>${t.type === 'recharge' ? '💰 充值' : '📝 消费'}</strong>
                <span style="margin-left: 10px;">${t.description}</span>
              </div>
              <div>
                <span style="color: ${t.type === 'recharge' ? '#28a745' : '#dc3545'}; font-weight: 600;">
                  ${t.type === 'recharge' ? '+' : ''}¥${Math.abs(t.amount).toFixed(2)}
                </span>
                <span style="margin-left: 10px; color: #999; font-size: 12px;">
                  ${new Date(t.created_at).toLocaleString('zh-CN')}
                </span>
              </div>
            </div>
          `).join('');
          document.getElementById('transactionsContainer').innerHTML = html;
        } else {
          document.getElementById('transactionsContainer').innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">暂无交易记录</div>';
        }
      } catch (error) {
        console.error('加载交易记录失败:', error);
      }
    }

    function selectPlan(planId) {
      selectedPlanId = planId;
      document.querySelectorAll('.plan-card').forEach((card, index) => {
        card.classList.toggle('selected', index + 1 === planId);
      });
    }

    function selectPayment(method) {
      selectedPaymentMethod = method;
      document.querySelectorAll('.payment-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.closest('.payment-btn').classList.add('selected');
    }

    async function recharge() {
      if (!selectedPlanId) {
        alert('❌ 请选择充值套餐');
        return;
      }
      if (!selectedPaymentMethod) {
        alert('❌ 请选择支付方式');
        return;
      }

      const token = localStorage.getItem('token');
      const rechargeBtn = event.target;
      rechargeBtn.disabled = true;
      rechargeBtn.innerHTML = '<span class="loading-spinner"></span>充值中...';
      
      try {
        const response = await fetch(`${API_BASE}/api/auth/recharge`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            planId: selectedPlanId,
            paymentMethod: selectedPaymentMethod
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Success animation
          rechargeBtn.innerHTML = '✅ 充值成功！';
          rechargeBtn.style.background = '#28a745';
          
          setTimeout(() => {
            alert(`🎉 充值成功！\n\n新余额: ¥${result.newBalance.toFixed(2)}\n\n感谢您的支持！`);
            loadProfile();
            
            // Reset button
            setTimeout(() => {
              rechargeBtn.disabled = false;
              rechargeBtn.innerHTML = '💰 立即充值（演示版-自动到账）';
              rechargeBtn.style.background = '';
            }, 1000);
          }, 500);
        } else {
          alert('❌ 充值失败: ' + result.error);
          rechargeBtn.disabled = false;
          rechargeBtn.innerHTML = '💰 立即充值（演示版-自动到账）';
        }
      } catch (error) {
        console.error('充值错误:', error);
        alert('❌ 充值失败，请稍后重试');
        rechargeBtn.disabled = false;
        rechargeBtn.innerHTML = '💰 立即充值（演示版-自动到账）';
      }
    }

    async function changePassword() {
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (!oldPassword || !newPassword || !confirmPassword) {
        alert('请填写所有密码字段');
        return;
      }

      if (newPassword.length < 8) {
        alert('新密码至少需要8位');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('两次输入的新密码不一致');
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/auth/change-password`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ oldPassword, newPassword })
        });

        const result = await response.json();

        if (result.success) {
          alert('✅ 密码修改成功！请重新登录');
          logout();
        } else {
          alert('❌ ' + result.error);
        }
      } catch (error) {
        console.error('修改密码错误:', error);
        alert('修改密码失败，请稍后重试');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/public/login.html';
    }

    // ==================== Membership Level ====================
    
    async function loadMembershipLevel() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/membership/my-level`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        if (result.success) {
          renderMembershipLevel(result.membership);
        }
      } catch (error) {
        console.error('加载会员等级失败:', error);
      }
    }
    
    function renderMembershipLevel(membership) {
      if (!membership) {
        document.getElementById('membershipLevelContainer').innerHTML = '<div style="color: #999;">暂无等级信息</div>';
        return;
      }
      
      const html = `
        <div style="background: linear-gradient(135deg, ${membership.badge_color || '#95a5a6'}20 0%, ${membership.badge_color || '#95a5a6'}40 100%); padding: 25px; border-radius: 12px; border-left: 5px solid ${membership.badge_color || '#95a5a6'};">
          <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
            <div style="font-size: 48px;">${membership.badge_icon || '🌱'}</div>
            <div>
              <div style="font-size: 24px; font-weight: bold; color: ${membership.badge_color || '#95a5a6'};">
                ${membership.name}
              </div>
              <div style="font-size: 14px; color: #666; margin-top: 5px;">
                ${membership.description}
              </div>
            </div>
          </div>
          
          <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
              <div style="text-align: center;">
                <div style="font-size: 12px; color: #999;">累计消费</div>
                <div style="font-size: 20px; font-weight: bold; color: #667eea;">¥${parseFloat(membership.total_spending || 0).toFixed(2)}</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 12px; color: #999;">会员折扣</div>
                <div style="font-size: 20px; font-weight: bold; color: #28a745;">${membership.discount_rate || 0}%</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 12px; color: #999;">推荐奖励</div>
                <div style="font-size: 20px; font-weight: bold; color: #ffc107;">¥${parseFloat(membership.referral_bonus || 0).toFixed(2)}</div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('membershipLevelContainer').innerHTML = html;
    }
    
    // ==================== Coupons ====================
    
    async function loadCoupons() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/membership/my-coupons`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        if (result.success) {
          renderCoupons(result.coupons);
        }
      } catch (error) {
        console.error('加载优惠券失败:', error);
      }
    }
    
    function renderCoupons(coupons) {
      if (!coupons || coupons.length === 0) {
        document.getElementById('couponsContainer').innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无优惠券</div>';
        return;
      }
      
      const html = coupons.map(coupon => {
        const isExpired = new Date(coupon.valid_until) < new Date();
        const isUsed = coupon.is_used;
        const statusBadge = isUsed ? '已使用' : isExpired ? '已过期' : '可用';
        const statusColor = isUsed ? '#999' : isExpired ? '#f39c12' : '#28a745';
        
        return `
          <div style="background: ${isUsed || isExpired ? '#f5f5f5' : 'linear-gradient(135deg, #667eea20 0%, #764ba240 100%)'}; border: 2px dashed ${statusColor}; border-radius: 12px; padding: 15px; margin-bottom: 10px; position: relative; ${isUsed || isExpired ? 'opacity: 0.6;' : ''}">
            <div style="position: absolute; top: 10px; right: 10px; background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
              ${statusBadge}
            </div>
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">${coupon.name}</div>
            <div style="font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 5px;">
              ${coupon.type === 'percentage' ? coupon.discount_value + '折' : '¥' + parseFloat(coupon.discount_value).toFixed(2)}
            </div>
            <div style="font-size: 12px; color: #666;">
              最低消费: ¥${parseFloat(coupon.min_purchase).toFixed(2)} | 
              有效期至: ${new Date(coupon.valid_until).toLocaleDateString('zh-CN')}
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">
              优惠码: ${coupon.code}
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('couponsContainer').innerHTML = html;
    }
    
    async function claimCoupon() {
      const code = document.getElementById('couponCode').value.trim();
      if (!code) {
        alert('请输入优惠券码');
        return;
      }
      
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/membership/claim-coupon`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ code })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('✅ 优惠券领取成功！');
          document.getElementById('couponCode').value = '';
          loadCoupons();
        } else {
          alert('❌ ' + (result.error || '领取失败'));
        }
      } catch (error) {
        console.error('领取优惠券失败:', error);
        alert('❌ 领取失败');
      }
    }
    
    // ==================== Referrals ====================
    
    async function loadReferralInfo() {
      const token = localStorage.getItem('token');
      try {
        // Load referral code
        const codeResponse = await fetch(`${API_BASE}/api/membership/my-referral-code`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const codeResult = await codeResponse.json();
        
        if (codeResult.success) {
          document.getElementById('referralCode').textContent = codeResult.referralCode;
        }
        
        // Load referrals and stats
        const referralsResponse = await fetch(`${API_BASE}/api/membership/my-referrals`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const referralsResult = await referralsResponse.json();
        
        if (referralsResult.success) {
          renderReferralStats(referralsResult.stats);
          renderReferralList(referralsResult.referrals);
        }
      } catch (error) {
        console.error('加载推荐信息失败:', error);
      }
    }
    
    function renderReferralStats(stats) {
      const html = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">推荐人数</div>
            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${stats.total_referrals || 0}</div>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">已奖励</div>
            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${stats.rewarded_referrals || 0}</div>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">累计奖励</div>
            <div style="font-size: 24px; font-weight: bold; color: #ffc107;">¥${parseFloat(stats.total_rewards || 0).toFixed(2)}</div>
          </div>
        </div>
      `;
      
      document.getElementById('referralStatsContainer').innerHTML = html;
    }
    
    function renderReferralList(referrals) {
      if (!referrals || referrals.length === 0) {
        document.getElementById('referralListContainer').innerHTML = '<div style="text-align: center; color: #999; padding: 20px; background: #f8f9fa; border-radius: 8px;">还没有推荐记录</div>';
        return;
      }
      
      const html = `
        <h4 style="margin-bottom: 15px;">推荐记录</h4>
        <div style="max-height: 300px; overflow-y: auto;">
          ${referrals.map(ref => `
            <div style="background: white; border: 1px solid #e0e0e0; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600;">👤 ${ref.referred_username}</div>
                  <div style="font-size: 12px; color: #666;">注册时间: ${new Date(ref.referred_created_at).toLocaleDateString('zh-CN')}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-weight: bold; color: ${ref.reward_given ? '#28a745' : '#ffc107'};">
                    ${ref.reward_given ? '✅ 已奖励' : '⏳ 待激活'}
                  </div>
                  <div style="font-size: 12px; color: #666;">¥${parseFloat(ref.reward_amount).toFixed(2)}</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      document.getElementById('referralListContainer').innerHTML = html;
    }
    
    function copyReferralCode() {
      const code = document.getElementById('referralCode').textContent;
      if (!code || code === '--------') {
        alert('推荐码加载中，请稍候');
        return;
      }
      
      navigator.clipboard.writeText(code).then(() => {
        alert('✅ 推荐码已复制到剪贴板！\n\n' + code + '\n\n分享给好友即可获得奖励');
      }).catch(() => {
        alert('复制失败，您的推荐码是：' + code);
      });
    }

    loadProfile();
  </script>
</body>
</html>
