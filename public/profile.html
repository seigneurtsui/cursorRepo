<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼šå‘˜ä¸­å¿ƒ - è§†é¢‘ç« èŠ‚ç”Ÿæˆå™¨</title>
  <link rel="stylesheet" href="/public/styles.css">
  <style>
    .profile-container { max-width: 900px; margin: 20px auto; padding: 20px; }
    .profile-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; }
    .balance-display { font-size: 48px; font-weight: bold; margin: 10px 0; }
    .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .card h3 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    .plan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px; }
    .plan-card { border: 2px solid #ddd; padding: 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
    .plan-card:hover { border-color: #007bff; transform: translateY(-2px); }
    .plan-card.selected { border-color: #007bff; background: #f0f8ff; }
    .plan-price { font-size: 32px; font-weight: bold; color: #007bff; margin: 10px 0; }
    .payment-methods { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .payment-btn { padding: 12px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; transition: all 0.3s; text-align: center; }
    .payment-btn:hover { border-color: #28a745; }
    .payment-btn.selected { border-color: #28a745; background: #f0fff0; }
    .btn-primary { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
    .btn-primary:hover { background: #0056b3; }
    .info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .nav-buttons { text-align: right; margin-bottom: 15px; }
    .nav-buttons button { margin-left: 10px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="profile-container">
    <div class="nav-buttons">
      <button onclick="window.location.href='/'">ğŸ¬ è¿”å›ä¸»é¡µ</button>
      <button onclick="logout()">ğŸšª é€€å‡ºç™»å½•</button>
    </div>

    <div class="profile-header">
      <h2>ğŸ‘¤ ä¼šå‘˜ä¸­å¿ƒ</h2>
      <div id="userInfo">
        <div style="font-size: 20px; margin-bottom: 10px;">æ¬¢è¿ï¼Œ<span id="username">åŠ è½½ä¸­...</span></div>
        <div style="font-size: 14px; opacity: 0.9;">è´¦å·ï¼š<span id="email">åŠ è½½ä¸­...</span></div>
      </div>
      <div class="balance-display">
        Â¥ <span id="balance">0.00</span>
      </div>
      <div style="font-size: 14px; opacity: 0.9;">å½“å‰ä½™é¢</div>
    </div>

    <!-- å……å€¼å¥—é¤ -->
    <div class="card">
      <h3>ğŸ’° å……å€¼å¥—é¤</h3>
      <div class="plan-grid" id="plansContainer">
        <div class="plan-card" onclick="selectPlan(1)">
          <div style="font-size: 18px; font-weight: 600;">æŒ‰æ¬¡ä»˜è´¹</div>
          <div class="plan-price">Â¥5</div>
          <div style="color: #666; font-size: 14px;">å•æ¬¡è§†é¢‘å¤„ç†</div>
        </div>
        <div class="plan-card" onclick="selectPlan(2)">
          <div style="font-size: 18px; font-weight: 600;">æœˆåº¦å¥—é¤</div>
          <div class="plan-price">Â¥50</div>
          <div style="color: #666; font-size: 14px;">æœˆåº¦æ— é™æ¬¡ä½¿ç”¨</div>
        </div>
        <div class="plan-card" onclick="selectPlan(3)">
          <div style="font-size: 18px; font-weight: 600; color: #ff6b6b;">å¹´åº¦å¥—é¤ ğŸ”¥</div>
          <div class="plan-price">Â¥300</div>
          <div style="color: #666; font-size: 14px;">å¹´åº¦æ— é™æ¬¡ä½¿ç”¨</div>
        </div>
      </div>

      <h4 style="margin-top: 25px; margin-bottom: 10px;">é€‰æ‹©æ”¯ä»˜æ–¹å¼</h4>
      <div class="payment-methods">
        <div class="payment-btn" onclick="selectPayment('alipay')">
          <div style="font-size: 24px;">ğŸ’³</div>
          <div style="font-size: 14px;">æ”¯ä»˜å®</div>
        </div>
        <div class="payment-btn" onclick="selectPayment('wechat')">
          <div style="font-size: 24px;">ğŸ’š</div>
          <div style="font-size: 14px;">å¾®ä¿¡æ”¯ä»˜</div>
        </div>
        <div class="payment-btn" onclick="selectPayment('stripe')">
          <div style="font-size: 24px;">ğŸ’³</div>
          <div style="font-size: 14px;">Stripe</div>
        </div>
        <div class="payment-btn" onclick="selectPayment('paypal')">
          <div style="font-size: 24px;">ğŸ’™</div>
          <div style="font-size: 14px;">PayPal</div>
        </div>
        <div class="payment-btn" onclick="selectPayment('visa')">
          <div style="font-size: 24px;">ğŸ’³</div>
          <div style="font-size: 14px;">Visa</div>
        </div>
        <div class="payment-btn" onclick="selectPayment('mastercard')">
          <div style="font-size: 24px;">ğŸ’³</div>
          <div style="font-size: 14px;">MasterCard</div>
        </div>
      </div>

      <button class="btn-primary" onclick="recharge()" style="width: 100%; margin-top: 20px; font-size: 18px;">
        ğŸ’° ç«‹å³å……å€¼ï¼ˆæ¼”ç¤ºç‰ˆ-è‡ªåŠ¨åˆ°è´¦ï¼‰
      </button>
      <div style="margin-top: 10px; color: #999; font-size: 12px; text-align: center;">
        âš ï¸ å½“å‰ä¸ºæ¼”ç¤ºç‰ˆæœ¬ï¼Œç‚¹å‡»å……å€¼å°†æ¨¡æ‹Ÿæ”¯ä»˜å¹¶ç«‹å³åˆ°è´¦
      </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç  -->
    <div class="card">
      <h3>ğŸ” ä¿®æ”¹å¯†ç </h3>
      <div style="max-width: 500px;">
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰å¯†ç </label>
          <input type="password" id="oldPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ–°å¯†ç </label>
          <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼‰" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">ç¡®è®¤æ–°å¯†ç </label>
          <input type="password" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <button class="btn-primary" onclick="changePassword()">ğŸ”’ ä¿®æ”¹å¯†ç </button>
      </div>
    </div>

    <!-- äº¤æ˜“è®°å½• -->
    <div class="card">
      <h3>ğŸ“Š æœ€è¿‘äº¤æ˜“è®°å½•</h3>
      <div id="transactionsContainer">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let selectedPlanId = null;
    let selectedPaymentMethod = null;
    let currentUser = null;

    async function loadProfile() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/public/login.html';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const result = await response.json();
        
        if (result.success) {
          currentUser = result.user;
          document.getElementById('username').textContent = currentUser.username;
          document.getElementById('email').textContent = currentUser.email;
          document.getElementById('balance').textContent = currentUser.balance.toFixed(2);
          
          loadTransactions();
        } else {
          window.location.href = '/public/login.html';
        }
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        window.location.href = '/public/login.html';
      }
    }

    async function loadTransactions() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/auth/transactions?limit=10`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        if (result.success && result.transactions.length > 0) {
          const html = result.transactions.map(t => `
            <div class="info-item">
              <div>
                <strong>${t.type === 'recharge' ? 'ğŸ’° å……å€¼' : 'ğŸ“ æ¶ˆè´¹'}</strong>
                <span style="margin-left: 10px;">${t.description}</span>
              </div>
              <div>
                <span style="color: ${t.type === 'recharge' ? '#28a745' : '#dc3545'}; font-weight: 600;">
                  ${t.type === 'recharge' ? '+' : ''}Â¥${Math.abs(t.amount).toFixed(2)}
                </span>
                <span style="margin-left: 10px; color: #999; font-size: 12px;">
                  ${new Date(t.created_at).toLocaleString('zh-CN')}
                </span>
              </div>
            </div>
          `).join('');
          document.getElementById('transactionsContainer').innerHTML = html;
        } else {
          document.getElementById('transactionsContainer').innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æš‚æ— äº¤æ˜“è®°å½•</div>';
        }
      } catch (error) {
        console.error('åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥:', error);
      }
    }

    function selectPlan(planId) {
      selectedPlanId = planId;
      document.querySelectorAll('.plan-card').forEach((card, index) => {
        card.classList.toggle('selected', index + 1 === planId);
      });
    }

    function selectPayment(method) {
      selectedPaymentMethod = method;
      document.querySelectorAll('.payment-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.closest('.payment-btn').classList.add('selected');
    }

    async function recharge() {
      if (!selectedPlanId) {
        alert('è¯·é€‰æ‹©å……å€¼å¥—é¤');
        return;
      }
      if (!selectedPaymentMethod) {
        alert('è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼');
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/auth/recharge`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            planId: selectedPlanId,
            paymentMethod: selectedPaymentMethod
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`å……å€¼æˆåŠŸï¼\næ–°ä½™é¢: Â¥${result.newBalance.toFixed(2)}`);
          loadProfile();
        } else {
          alert('å……å€¼å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        console.error('å……å€¼é”™è¯¯:', error);
        alert('å……å€¼å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    async function changePassword() {
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (!oldPassword || !newPassword || !confirmPassword) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ');
        return;
      }

      if (newPassword.length < 8) {
        alert('æ–°å¯†ç è‡³å°‘éœ€è¦8ä½');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE}/api/auth/change-password`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ oldPassword, newPassword })
        });

        const result = await response.json();

        if (result.success) {
          alert('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼è¯·é‡æ–°ç™»å½•');
          logout();
        } else {
          alert('âŒ ' + result.error);
        }
      } catch (error) {
        console.error('ä¿®æ”¹å¯†ç é”™è¯¯:', error);
        alert('ä¿®æ”¹å¯†ç å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/public/login.html';
    }

    // Load profile on page load
    loadProfile();
  </script>
</body>
</html>
